[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2026-01-20 23:27:28.227319",
  "module": "dms_plus",
  "name": "Pricing & Discounts WorkFlow",
  "script": "frappe.ui.form.on(\"Quotation\", {\n\n    after_save(frm) {\n        validateDiscountRules(frm);\n    },\n    \n    discount_amount(frm) {\n        validateDiscountAmount(frm);\n    },\n    \n    additional_discount_percentage(frm) {\n        validateAdditionalDiscount(frm);\n    },\n    \n    price_list(frm) {\n        validatePriceListChange(frm);\n    }\n});\n\nfunction applyDiscountPermissions(frm) {\n    const userRoles = frappe.user_roles;\n    \n    console.log(\"Current User Roles:\", userRoles);\n    \n    let maxDiscountPercentage = 0;\n    let canChangePrice = false;\n    let canApplyDiscount = true;\n    let canApplyAmountDiscount = true;\n    let isCoordinator = false;\n    \n    if (userRoles.includes(\"Sales Manager\")) {\n        maxDiscountPercentage = 100; \n        canChangePrice = true;\n        canApplyDiscount = true;\n        canApplyAmountDiscount = true;\n        console.log(\"Sales Manager - Full permissions\");\n        \n    } else if (userRoles.includes(\"Product Manager\")) {\n        maxDiscountPercentage = 100;\n        canChangePrice = true;\n        canApplyDiscount = true;\n        canApplyAmountDiscount = true;\n        console.log(\"Product Manager - Full permissions\");\n        \n    } else if (userRoles.includes(\"Senior Sales\")) {\n        maxDiscountPercentage = 10;\n        canChangePrice = true;\n        canApplyDiscount = true;\n        canApplyAmountDiscount = false; \n        console.log(\"Senior Sales - Max 10% discount\");\n        \n    } else if (userRoles.includes(\"Junior Sales\")) {\n        maxDiscountPercentage = 5;\n        canChangePrice = false;\n        canApplyDiscount = true;\n        canApplyAmountDiscount = false; \n        console.log(\"Junior Sales - Max 5% discount\");\n        \n    } else if (userRoles.includes(\"Sales Coordinator\")) {\n        maxDiscountPercentage = 0;\n        canChangePrice = false;\n        canApplyDiscount = false;\n        canApplyAmountDiscount = false;\n        isCoordinator = true;\n        console.log(\"Sales Coordinator - Cannot apply discount\");\n    }\n    \n    frm.maxDiscountPercentageAllowed = maxDiscountPercentage;\n    frm.canChangePrice = canChangePrice;\n    frm.canApplyDiscount = canApplyDiscount;\n    frm.canApplyAmountDiscount = canApplyAmountDiscount;\n    \n    frm.set_df_property(\"discount_amount\", \"read_only\", !canApplyAmountDiscount);\n    frm.set_df_property(\"additional_discount_percentage\", \"read_only\", !canApplyDiscount);\n    frm.set_df_property(\"price_list\", \"read_only\", !canChangePrice);\n    \n    if (isCoordinator) {\n        frm.set_df_property(\"discount_amount\", \"read_only\", 1);\n        frm.set_df_property(\"additional_discount_percentage\", \"read_only\", 1);\n        frm.set_df_property(\"price_list\", \"read_only\", 1);\n        \n        frappe.msgprint({\n            title: \"Notice\",\n            message: \"You are a <b>Sales Coordinator</b>. You can only enter prices from the Price List. You are not allowed to apply discounts.\",\n            indicator: \"blue\"\n        });\n\n    }\n    \n    frm.refresh_field(\"discount_amount\");\n    frm.refresh_field(\"additional_discount_percentage\");\n    frm.refresh_field(\"price_list\");\n}\nfunction validateDiscountAmount(frm) {\n    if (!frm.canApplyAmountDiscount && frm.doc.discount_amount > 0) {\n        frappe.msgprint({\n            title: \"Permission Error\",\n            message: \"You do not have permission to apply a fixed amount discount!<br>You can only apply a percentage discount.\",\n            indicator: \"red\"\n        });\n        frm.set_value(\"discount_amount\", 0);\n        return false;\n    }\n    \n    if (frm.doc.discount_amount > 0 && frm.doc.net_total) {\n        const discountPercentage = (frm.doc.discount_amount / frm.doc.net_total) * 100;\n        \n        if (discountPercentage > 20) {\n            frappe.msgprint({\n                title: \"Warning - High Discount\",\n                message: `The discount amount <b>${frm.doc.discount_amount}</b> represents <b>${discountPercentage.toFixed(2)}%</b> of the total.`,\n                indicator: \"orange\"\n            });\n\n        }\n    }\n}\n\nfunction validateAdditionalDiscount(frm) {\n    if (!frm.maxDiscountPercentageAllowed && frm.maxDiscountPercentageAllowed !== 0) {\n        applyDiscountPermissions(frm);\n    }\n    \n    const additionalDiscount = frm.doc.additional_discount_percentage || 0;\n        if (!frm.canApplyDiscount && additionalDiscount > 0) {\n        frappe.msgprint({\n            title: \"Permission Error\",\n            message: \"You do not have permission to apply discounts!\",\n            indicator: \"red\"\n        });\n\n        frm.set_value(\"additional_discount_percentage\", 0);\n        return false;\n    }\n    \n    if (frm.maxDiscountPercentageAllowed < 100 && additionalDiscount > frm.maxDiscountPercentageAllowed) {\n            frappe.msgprint({\n                title: \"Discount Limit Exceeded\",\n                message: `<b>Allowed discount limit: ${frm.maxDiscountPercentageAllowed}%</b><br>\n                          Requested discount: ${additionalDiscount}%<br><br>\n                          Please reduce the discount to the allowed limit.`,\n                indicator: \"red\"\n            });\n\n        \n        frm.set_value(\"additional_discount_percentage\", frm.maxDiscountPercentageAllowed);\n        return false;\n    }\n    \n    if (frm.maxDiscountPercentageAllowed < 100 && additionalDiscount > frm.maxDiscountPercentageAllowed * 0.8) {\n        frappe.msgprint({\n                title: \"Warning\",\n                message: `You are approaching the maximum allowed discount (${frm.maxDiscountPercentageAllowed}%).<br>\n                          Current discount: ${additionalDiscount}%`,\n                indicator: \"orange\"\n            });\n\n    }\n}\n\nfunction validatePriceListChange(frm) {\n    if (!frm.canChangePrice) {\n        frappe.msgprint({\n            title: \"Permission Error\",\n            message: \"You do not have permission to change the Price List!\",\n            indicator: \"red\"\n        });\n\n        \n        frm.reload_doc();\n        return false;\n    }\n}\n\nfunction validateDiscountRules(frm) {\n    const userRoles = frappe.user_roles;\n    const discountAmount = frm.doc.discount_amount || 0;\n    const additionalDiscount = frm.doc.additional_discount_percentage || 0;\n    const totalDiscount = discountAmount + additionalDiscount;\n    \n    console.log({\n        user: frappe.session.user,\n        roles: userRoles,\n        discount_amount: discountAmount,\n        additional_discount_percentage: additionalDiscount,\n        total_discount: totalDiscount,\n        grand_total: frm.doc.grand_total\n    });\n    \n    if (additionalDiscount > 5) {\n        frappe.msgprint({\n            title: \"High Discount\",\n            message: `An additional discount of ${additionalDiscount}% has been applied to this quotation.`,\n            indicator: \"yellow\"\n        });\n\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2026-01-20 23:27:28.319826",
  "module": "dms_plus",
  "name": "Restrict Junior Sales From Adding Item Groups  Professional Services",
  "script": "frappe.ui.form.on(\"Quotation\", {\n    // onload(frm) {\n    //     applyItemRestrictions(frm);\n    // }\n});\n\nfrappe.ui.form.on(\"Quotation Item\", {\n    item_code(frm, cdt, cdn) {\n        validateItemRestrictions(frm, cdt, cdn);\n    },\n    \n    items_add(frm, cdt, cdn) {\n        applyItemRestrictions(frm);\n    }\n});\n\n// function applyItemRestrictions(frm) {\n//     const userRoles = frappe.user_roles || [];\n//     if (!userRoles.includes(\"Junior Sales\")) return;\n\n//     const restrictedItemGroups = [\"Professional Services\"];\n//     let removed = false;\n\n//     const promises = (frm.doc.items || []).map(row => {\n//         if (!row.item_code) return Promise.resolve();\n\n//         return frappe.db\n//             .get_value(\"Item\", row.item_code, \"item_group\")\n//             .then(r => {\n//                 const itemGroup = r.message?.item_group;\n//                 if (restrictedItemGroups.includes(itemGroup)) {\n//                     frappe.model.clear_doc(row.doctype, row.name);\n//                     removed = true;\n//                 }\n//             });\n//     });\n\n//     Promise.all(promises).then(() => {\n//         if (removed) {\n//             frm.refresh_field(\"items\");\n\n//             if (!frm.__restriction_notified) {\n//                 frm.__restriction_notified = true;\n\n//                 frappe.msgprint({\n//                     title: \"Notice - Item Restrictions\",\n//                     message: \"Items from the <b>Professional Services</b> group have been removed because you are a <b>Junior Sales</b> user\",\n//                     indicator: \"blue\"\n//                 });\n//             }\n//         }\n//     });\n// }\n\nfunction validateItemRestrictions(frm, cdt, cdn) {\n    const row = locals[cdt][cdn];\n    if (!row.item_code) return;\n\n        frappe.call({\n            method: \"dms_plus.crm_permissions.customer_permissions.check_item_permission\",\n            args: {\n                item_code: row.item_code\n            },\n            callback(r) {\n                const res = r.message;\n                if (!res) return;\n                console.log(\"res\",res)\n                if (res.allowed === false) {\n                    frappe.msgprint({\n                        title: \"Permission Denied\",\n                        message: `\n                            <b>Item:</b> ${row.item_code}<br>\n                            <b>Group:</b> ${res.item_group}<br><br>\n                            ${res.reason}\n                        `,\n                        indicator: \"red\"\n                    });\n\n                                        // Delete Row\n                    cur_frm.doc.items.splice(\n                        cur_frm.doc.items.indexOf(row), 1\n                    );\n                    frm.refresh_field(\"items\");\n                }\n            }\n        });\n    }\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2026-01-21 21:21:18.162302",
  "module": "dms_plus",
  "name": "Restrict Add Professional Services Item Groups For Juniors Sales",
  "script": "\nfrappe.ui.form.on(\"Sales Order Item\", {\n    item_code(frm, cdt, cdn) {\n        validateItemRestrictions(frm, cdt, cdn);\n    },\n    \n    items_add(frm, cdt, cdn) {\n        applyItemRestrictions(frm);\n    }\n});\n\n\nfunction validateItemRestrictions(frm, cdt, cdn) {\n    const row = locals[cdt][cdn];\n    if (!row.item_code) return;\n\n        frappe.call({\n            method: \"dms_plus.crm_permissions.customer_permissions.check_item_permission\",\n            args: {\n                item_code: row.item_code\n            },\n            callback(r) {\n                const res = r.message;\n                if (!res) return;\n                console.log(\"res\",res)\n                if (res.allowed === false) {\n                    frappe.msgprint({\n                        title: \"Permission Denied\",\n                        message: `\n                            <b>Item:</b> ${row.item_code}<br>\n                            <b>Group:</b> ${res.item_group}<br><br>\n                            ${res.reason}\n                        `,\n                        indicator: \"red\"\n                    });\n\n                                        // Delete Row\n                    cur_frm.doc.items.splice(\n                        cur_frm.doc.items.indexOf(row), 1\n                    );\n                    frm.refresh_field(\"items\");\n                }\n            }\n        });\n    }\n\n",
  "view": "Form"
 }
]