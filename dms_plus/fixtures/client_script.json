[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2026-02-02 15:33:17.555872",
  "module": "dms_plus",
  "name": "Quotation Workflow Wise the Base Amount",
  "script": "frappe.ui.form.on(\"Quotation\", {\n    before_workflow_action(frm) {\n        \n        frm._last_workflow_action = frm.selected_workflow_action;\n        console.log(\"Before Workflow Action:\", frm._last_workflow_action);\n\n            const total = frm.doc.base_grand_total || 0;\n            \n            if (total <= 0) {\n                frappe.msgprint(\"Amount Must Be Greater Than 0\");\n                frappe.validated = false;\n                return false;\n            }\n\n            const roles = frappe.user_roles;\n            console.log(\"Roles:\", roles);\n                    \n            let approvalLimit = 0;\n            const hasAll = (requiredRoles) => requiredRoles.every(role => roles.includes(role));\n            \n            if (hasAll([\"Sales Manager - Network\"])) {\n                    console.log(\"Sales Manager - No limit\");\n                    return true;\n                    \n            }\n            // =============== Senior Sales - Network DEPT ==============================\n            else if (hasAll([\"Senior Sales - Network DEPT\"])) {\n                    approvalLimit = 150000;\n                    console.log(\"Senior - Limit: 150,000 SR\");\n                \n            } \n              // ===== Junior Sales - Network DEPT =====\n            else if (hasAll([\"Junior Sales - Network DEPT\"])) {\n                approvalLimit = 75000;\n                console.log(\"Junior - Limit: 75,000 SR\");\n                \n            }\n            // ===== Sales Coordinator =====\n            else if (hasAll([\"Sales Coordinator - Network DEPT\"])) {\n                    approvalLimit = 75000; \n            }\n                \n            else {\n                \n                return;\n            }\n                    \n            if (total > approvalLimit) {\n                frappe.msgprint({\n                    title: \"Approval Alert\",\n                    message: `This quotation with a value of <b>${total.toLocaleString()} SR</b> exceeds your approval limit (${approvalLimit.toLocaleString()} SR).<br><br>It will be forwarded to the Sales Manager for approval.`,\n                    indicator: \"blue\"\n                });\n          \n                frm.set_value(\"workflow_state\", \"Pending Approval\");\n\n            } else {\n               return\n\n            }\n                    \n    \n    }\n});\n\nfrappe.ui.form.on(\"Quotation\", {\n    after_workflow_action(frm) {\n        if (frm.doc.workflow_state === \"Pending Approval\") {\n            const roles = frappe.user_roles;\n             const hasRole = (role) => roles.includes(role);\n            // const hasAll = (requiredRoles) => requiredRoles.every(role => roles.includes(role));\n            \n            if (hasRole(\"Junior Sales - Network DEPT\") || hasRole(\"Senior Sales - Network DEPT\")) {\n                frappe.call({\n                    method: \"frappe.desk.form.utils.add_comment\",\n                    args: {\n                        reference_doctype: frm.doctype,\n                        reference_name: frm.doc.name,\n                        content: `The quotation with a value of ${frm.doc.base_grand_total.toLocaleString()} SR requires Sales Manager approval.`,\n                        comment_email: frappe.session.user,\n                        comment_by: frappe.session.user_fullname\n                      }\n                });\n                \n                    \n            }\n            \n            // \"Senior Sales - Network DEPT\"\n            \n        }\n    },\n    onload(frm){\n      if (frm.doc.workflow_state === \"Pending Approval\") {\n            const roles = frappe.user_roles;\n            // const hasAll = (requiredRoles) => requiredRoles.every(role => roles.includes(role));\n            const hasRole = (role) => roles.includes(role);\n               if (hasRole(\"Junior Sales - Network DEPT\")) {\n                    frm.dashboard.add_comment(\n        \t\t\t\t__(`The quotation with a value of ${frm.doc.base_grand_total.toLocaleString()} SR requires Sales Manager approval.`),\n        \t\t\t\t\"yellow\"\n        \t\t\t);\n               }\n               if (hasRole(\"Senior Sales - Network DEPT\")) {\n                    frm.dashboard.add_comment(\n                        __( `Quotation with value ${frm.doc.base_grand_total.toLocaleString()} SR requires Sales Manager approval (Senior Sales).` ),\n                        \"orange\"\n                    );\n                }\n\n        }\n    }\n});\n\nfrappe.ui.form.on(\"Quotation\", {\n     refresh(frm) {\n        setTimeout(function () {\n            const total = frm.doc.base_grand_total || 0;\n            const roles = frappe.user_roles;\n            \n            const hasRole = (role) => roles.includes(role);\n            //  const hasAll = (requiredRoles) =>\n            //     requiredRoles.every(role => roles.includes(role));\n                \n            let approvalLimit = null;\n\n            if (hasRole([\"Sales Manager - Network\"])) {\n                approvalLimit = Infinity;\n            }\n            \n            else if (hasRole([\"Senior Sales - Network DEPT\"])) {\n                approvalLimit = 150000;\n            } \n            \n             else if (hasRole([\"Junior Sales - Network DEPT\"])) {\n                approvalLimit = 75000;\n            }\n       \n            else if (hasRole([\"Sales Coordinator - Network DEPT\"])) {\n                approvalLimit = 150000;\n            }\n\n        if (approvalLimit !== null) {\n            if (total < approvalLimit) {\n                console.log(\"approvalLimit\",\"NO\");\n                cur_frm.page.actions.find('[data-label=\"Submit%20for%20Approval\"]').parent().parent().remove();\n            } else {\n                console.log(\"approvalLimit\",\"YES\");\n                cur_frm.page.actions.find('[data-label=\"Submit\"]').parent().parent().remove();\n            }\n        } else {\n            // شخص لا يحقق أي شرط → لا نغير الأزرار\n            console.log(\"User not affected, approvalLimit is null\");\n        }\n\n        }, 400);\n    },\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2026-02-02 16:16:05.938945",
  "module": "dms_plus",
  "name": "Pricing & Discounts WorkFlow",
  "script": "frappe.ui.form.on(\"Quotation\", {\n\n    after_save(frm) {\n        validateDiscountRules(frm);\n    },\n    \n    discount_amount(frm) {\n        validateDiscountAmount(frm);\n    },\n    \n    additional_discount_percentage(frm) {\n        validateAdditionalDiscount(frm);\n    },\n    \n    price_list(frm) {\n        validatePriceListChange(frm);\n    }\n});\n\nfunction applyDiscountPermissions(frm) {\n    const userRoles = frappe.user_roles;\n    \n    console.log(\"Current User Roles:\", userRoles);\n    \n    let maxDiscountPercentage = 0;\n    let canChangePrice = false;\n    let canApplyDiscount = true;\n    let canApplyAmountDiscount = true;\n    let isCoordinator = false;\n    \n    if (userRoles.includes(\"Sales Manager - Network\") || userRoles.includes(\"Sales Master Manager - Network\") ) {\n        maxDiscountPercentage = 100; \n        canChangePrice = true;\n        canApplyDiscount = true;\n        canApplyAmountDiscount = true;\n        console.log(\"Senior Sales - Network - Full permissions\");\n        \n    } else if (userRoles.includes(\"Product MGR - Network\")) {\n        maxDiscountPercentage = 100;\n        canChangePrice = true;\n        canApplyDiscount = true;\n        canApplyAmountDiscount = true;\n        console.log(\"Product MGR - Network - Full permissions\");\n        \n    } else if (userRoles.includes(\"Senior Sales - Network DEPT\")) {\n        maxDiscountPercentage = 10;\n        canChangePrice = true;\n        canApplyDiscount = true;\n        canApplyAmountDiscount = false; \n        console.log(\"Senior Sales - Network DEPT - Max 10% discount\");\n        \n    } else if (userRoles.includes(\"Junior Sales - Network DEPT\")) {\n        maxDiscountPercentage = 5;\n        canChangePrice = false;\n        canApplyDiscount = true;\n        canApplyAmountDiscount = false; \n        console.log(\"Junior Sales - Network DEPT - Max 5% discount\");\n        \n    } else if (userRoles.includes(\"Sales Coordinator - Network DEPT\")) {\n        maxDiscountPercentage = 0;\n        canChangePrice = false;\n        canApplyDiscount = false;\n        canApplyAmountDiscount = false;\n        isCoordinator = true;\n        console.log(\"Sales Coordinator - Network DEPT - Cannot apply discount\");\n    }\n    \n    frm.maxDiscountPercentageAllowed = maxDiscountPercentage;\n    frm.canChangePrice = canChangePrice;\n    frm.canApplyDiscount = canApplyDiscount;\n    frm.canApplyAmountDiscount = canApplyAmountDiscount;\n    \n    frm.set_df_property(\"discount_amount\", \"read_only\", !canApplyAmountDiscount);\n    frm.set_df_property(\"additional_discount_percentage\", \"read_only\", !canApplyDiscount);\n    frm.set_df_property(\"price_list\", \"read_only\", !canChangePrice);\n    \n    if (isCoordinator) {\n        frm.set_df_property(\"discount_amount\", \"read_only\", 1);\n        frm.set_df_property(\"additional_discount_percentage\", \"read_only\", 1);\n        frm.set_df_property(\"price_list\", \"read_only\", 1);\n        \n        frappe.msgprint({\n            title: \"Notice\",\n            message: \"You are a <b>Sales Coordinator - Network DEPT</b>. You can only enter prices from the Price List. You are not allowed to apply discounts.\",\n            indicator: \"blue\"\n        });\n\n    }\n    \n    frm.refresh_field(\"discount_amount\");\n    frm.refresh_field(\"additional_discount_percentage\");\n    frm.refresh_field(\"price_list\");\n}\nfunction validateDiscountAmount(frm) {\n    if (!frm.canApplyAmountDiscount && frm.doc.discount_amount > 0) {\n        frappe.msgprint({\n            title: \"Permission Error\",\n            message: \"You do not have permission to apply a fixed amount discount!<br>You can only apply a percentage discount.\",\n            indicator: \"red\"\n        });\n        frm.set_value(\"discount_amount\", 0);\n        return false;\n    }\n    \n    if (frm.doc.discount_amount > 0 && frm.doc.net_total) {\n        const discountPercentage = (frm.doc.discount_amount / frm.doc.net_total) * 100;\n        \n        if (discountPercentage > 20) {\n            frappe.msgprint({\n                title: \"Warning - High Discount\",\n                message: `The discount amount <b>${frm.doc.discount_amount}</b> represents <b>${discountPercentage.toFixed(2)}%</b> of the total.`,\n                indicator: \"orange\"\n            });\n\n        }\n    }\n}\n\nfunction validateAdditionalDiscount(frm) {\n    if (!frm.maxDiscountPercentageAllowed && frm.maxDiscountPercentageAllowed !== 0) {\n        applyDiscountPermissions(frm);\n    }\n    \n    const additionalDiscount = frm.doc.additional_discount_percentage || 0;\n        if (!frm.canApplyDiscount && additionalDiscount > 0) {\n        frappe.msgprint({\n            title: \"Permission Error\",\n            message: \"You do not have permission to apply discounts!\",\n            indicator: \"red\"\n        });\n\n        frm.set_value(\"additional_discount_percentage\", 0);\n        return false;\n    }\n    \n    if (frm.maxDiscountPercentageAllowed < 100 && additionalDiscount > frm.maxDiscountPercentageAllowed) {\n            frappe.msgprint({\n                title: \"Discount Limit Exceeded\",\n                message: `<b>Allowed discount limit: ${frm.maxDiscountPercentageAllowed}%</b><br>\n                          Requested discount: ${additionalDiscount}%<br><br>\n                          Please reduce the discount to the allowed limit.`,\n                indicator: \"red\"\n            });\n\n        \n        frm.set_value(\"additional_discount_percentage\", frm.maxDiscountPercentageAllowed);\n        return false;\n    }\n    \n    if (frm.maxDiscountPercentageAllowed < 100 && additionalDiscount > frm.maxDiscountPercentageAllowed * 0.8) {\n        frappe.msgprint({\n                title: \"Warning\",\n                message: `You are approaching the maximum allowed discount (${frm.maxDiscountPercentageAllowed}%).<br>\n                          Current discount: ${additionalDiscount}%`,\n                indicator: \"orange\"\n            });\n\n    }\n}\n\nfunction validatePriceListChange(frm) {\n    if (!frm.canChangePrice) {\n        frappe.msgprint({\n            title: \"Permission Error\",\n            message: \"You do not have permission to change the Price List!\",\n            indicator: \"red\"\n        });\n\n        \n        frm.reload_doc();\n        return false;\n    }\n}\n\nfunction validateDiscountRules(frm) {\n    const userRoles = frappe.user_roles;\n    const discountAmount = frm.doc.discount_amount || 0;\n    const additionalDiscount = frm.doc.additional_discount_percentage || 0;\n    const totalDiscount = discountAmount + additionalDiscount;\n    \n    console.log({\n        user: frappe.session.user,\n        roles: userRoles,\n        discount_amount: discountAmount,\n        additional_discount_percentage: additionalDiscount,\n        total_discount: totalDiscount,\n        grand_total: frm.doc.grand_total\n    });\n    \n    if (additionalDiscount > 5) {\n        frappe.msgprint({\n            title: \"High Discount\",\n            message: `An additional discount of ${additionalDiscount}% has been applied to this quotation.`,\n            indicator: \"yellow\"\n        });\n\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2026-02-01 20:13:57.737411",
  "module": "dms_plus",
  "name": "Restrict Junior Sales From Adding Item Groups  Professional Services",
  "script": "frappe.ui.form.on(\"Quotation Item\", {\n    item_code(frm, cdt, cdn) {\n        validateItemRestrictions(frm, cdt, cdn);\n    },\n    \n    items_add(frm, cdt, cdn) {\n        applyItemRestrictions(frm);\n    }\n});\n\nfunction validateItemRestrictions(frm, cdt, cdn) {\n    const row = locals[cdt][cdn];\n    if (!row.item_code) return;\n\n        frappe.call({\n            method: \"dms_plus.crm_permissions.customer_permissions.check_item_permission\",\n            args: {\n                item_code: row.item_code\n            },\n            callback(r) {\n                const res = r.message;\n                if (!res) return;\n                console.log(\"res\",res)\n                if (res.allowed === false) {\n                    frappe.msgprint({\n                        title: \"Permission Denied\",\n                        message: `\n                            <b>Item:</b> ${row.item_code}<br>\n                            <b>Group:</b> ${res.item_group}<br><br>\n                            ${res.reason}\n                        `,\n                        indicator: \"red\"\n                    });\n\n                                        // Delete Row\n                    cur_frm.doc.items.splice(\n                        cur_frm.doc.items.indexOf(row), 1\n                    );\n                    frm.refresh_field(\"items\");\n                }\n            }\n        });\n    }\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2026-02-01 16:20:32.480929",
  "module": "dms_plus",
  "name": "Restrict Add Professional Services Item Groups For Juniors Sales",
  "script": "\nfrappe.ui.form.on(\"Sales Order Item\", {\n    item_code(frm, cdt, cdn) {\n        validateItemRestrictions(frm, cdt, cdn);\n    },\n    \n    items_add(frm, cdt, cdn) {\n        applyItemRestrictions(frm);\n    }\n});\n\n\nfunction validateItemRestrictions(frm, cdt, cdn) {\n    const row = locals[cdt][cdn];\n    if (!row.item_code) return;\n\n        frappe.call({\n            method: \"dms_plus.crm_permissions.customer_permissions.check_item_permission\",\n            args: {\n                item_code: row.item_code\n            },\n            callback(r) {\n                const res = r.message;\n                if (!res) return;\n                console.log(\"res\",res)\n                if (res.allowed === false) {\n                    frappe.msgprint({\n                        title: \"Permission Denied\",\n                        message: `\n                            <b>Item:</b> ${row.item_code}<br>\n                            <b>Group:</b> ${res.item_group}<br><br>\n                            ${res.reason}\n                        `,\n                        indicator: \"red\"\n                    });\n\n                                        // Delete Row\n                    cur_frm.doc.items.splice(\n                        cur_frm.doc.items.indexOf(row), 1\n                    );\n                    frm.refresh_field(\"items\");\n                }\n            }\n        });\n    }\n\n",
  "view": "Form"
 }
]